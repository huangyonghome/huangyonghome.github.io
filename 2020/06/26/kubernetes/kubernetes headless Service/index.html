<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "59f7787a"
    });
  daovoice('update');
  </script>















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="k8s," />





  <link rel="alternate" href="/atom.xml" title="Jesse's home" type="application/atom+xml" />






<meta name="description" content="kubernetes headless Service​     我们以前学习过,Service是Kubernetes项目中用来将一组Pod暴露给外界访问的一种机制.外部客户端通过Service地址可以随机访问到某个具体的Pod ​     之前学过几种Service类型,包括nodeport,loadbalancer等等.所有这类Service都有一个VIP(虚拟IP),访问Service V">
<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes headless Service">
<meta property="og:url" content="https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/index.html">
<meta property="og:site_name" content="Jesse&#39;s home">
<meta property="og:description" content="kubernetes headless Service​     我们以前学习过,Service是Kubernetes项目中用来将一组Pod暴露给外界访问的一种机制.外部客户端通过Service地址可以随机访问到某个具体的Pod ​     之前学过几种Service类型,包括nodeport,loadbalancer等等.所有这类Service都有一个VIP(虚拟IP),访问Service V">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-06-26T08:48:46.557Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kubernetes headless Service">
<meta name="twitter:description" content="kubernetes headless Service​     我们以前学习过,Service是Kubernetes项目中用来将一组Pod暴露给外界访问的一种机制.外部客户端通过Service地址可以随机访问到某个具体的Pod ​     之前学过几种Service类型,包括nodeport,loadbalancer等等.所有这类Service都有一个VIP(虚拟IP),访问Service V">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/"/>





  <title>kubernetes headless Service | Jesse's home</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jesse's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jesse's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kubernetes headless Service</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-26T11:59:58+08:00">
                2020-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/26/kubernetes/kubernetes headless Service/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/06/26/kubernetes/kubernetes headless Service/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<h3 id="kubernetes-headless-Service"><a href="#kubernetes-headless-Service" class="headerlink" title="kubernetes headless Service"></a>kubernetes headless Service</h3><p>​     我们以前学习过,Service是Kubernetes项目中用来将一组Pod暴露给外界访问的一种机制.外部客户端通过Service地址可以随机访问到某个具体的Pod</p>
<p>​     之前学过几种Service类型,包括nodeport,loadbalancer等等.所有这类Service都有一个VIP(虚拟IP),访问Service VIP,Service会将请求转发到后端的Pod上,</p>
<p>​     还有一种Service是Headless Service(无头服务),这类Service自身不需要VIP,当DNS解析该Service时,会解析出Service后端的Pod地址.这样设置的好处是Kubernetes项目为Pod分配唯一的”可解析身份”,只要知道一个pod的名字和对应的Headless Service名字,就可以通过这条DNS访问到后端的Pod</p>
<a id="more"></a>
<hr>
<h3 id="持久存储"><a href="#持久存储" class="headerlink" title="持久存储"></a>持久存储</h3><p>我们知道通过headless Service使Pod有一个稳定的网络标识,那么存储呢?有状态的应用必须有自己独立的存储,即便这个pod被删除,新创建出来的pod(新pod与旧pod拥有相同的网络表示)也必须挂载相同的存储.</p>
<p>​      之前在学习kubernetes的存储时,我们学习过PV,PVC存储卷,通过pod模板关联一个持久卷声明就可以为pod提供一个持久卷存储.因为持久卷声明(PVC)和持久卷(PV)是一对一关系.但是之前接触过的ReplicationController,ReplicaSet,Deployment等资源创建的pod是同一个模板创建的,所以共享的是同一个持久卷存储.而StatefulSet要求每个pod都需要有独立的持久卷声明和存储.所以StatefulSet要求关联到一个或多个不同的持久卷声明模板.这些持久卷声明会在pod创建之前准备就绪,并且关联到每个pod中.</p>
<h3 id="持久卷的创建和删除"><a href="#持久卷的创建和删除" class="headerlink" title="持久卷的创建和删除"></a>持久卷的创建和删除</h3><p>​      扩容一个StatefulSet副本时,会创建2个或者多个对象: pod实例已经与之关联的一个或者多个持久卷声明.但是当StatefulSet缩容时,只会删除一个Pod,而留下持久卷声明.这就意味着删除Pod时,与pod关联的持久卷存储数据并不会被删除.如果持久卷声明被手动删除,那么持久卷上的数据则会消失.</p>
<p>​     因为缩容会保留持久卷声明,所以在随后的扩容操作中,新的pod实例会使用绑定在持久卷上相同的声明和其上的数据.所以如果因为误操作而缩容一个StatefulSet副本后,可以做一次扩容操作,新的pod实例会运行到与之前完全一致的状态,甚至连pod名字也是一样的</p>
<hr>
<h3 id="部署StatefulSet应用"><a href="#部署StatefulSet应用" class="headerlink" title="部署StatefulSet应用"></a>部署StatefulSet应用</h3><p>部署StatefulSet应用之前,需要创建几个不同类型的对象.</p>
<ul>
<li><p>一个演示用的docker镜像</p>
</li>
<li><p>存储数据文件的持久卷(PV)</p>
</li>
<li><p>一个Headless Service服务实例</p>
</li>
<li><p>Statefulset模板</p>
</li>
</ul>
<h4 id="准备一个docker镜像"><a href="#准备一个docker镜像" class="headerlink" title="准备一个docker镜像"></a>准备一个docker镜像</h4><p>这里使用书上提供的luksa/kubia-pet镜像,这个镜像是一个Node应用,当应用接收到一个POST请求时,将请求中的body写入到某个文件,当接收到一个GET请求时,返回pod主机名以及改文件中的内容.</p>
<h4 id="创建持久化存储卷-pv"><a href="#创建持久化存储卷-pv" class="headerlink" title="创建持久化存储卷(pv)"></a>创建持久化存储卷(pv)</h4><p>因为稍后会调度StatefulSet创建3个副本.所以这里需要3个持久卷.如果计划调度更多的副本,则需要创建更多的持久卷..</p>
<p>之前在学习存储知识的时候介绍过存储卷,所以具体不演示,以下是创建3个PV持久卷的配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">statefulset-kubia-pv.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="comment">#创建一个List列表资源,List的items下列出每个PV的配置</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">List</span></span><br><span class="line"><span class="attr">items:</span></span><br><span class="line"><span class="attr">  - apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">pv-1</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">       capacity:</span></span><br><span class="line"><span class="attr">         storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">       accessModes:</span></span><br><span class="line"><span class="bullet">         -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">       persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">       storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">       nfs:</span></span><br><span class="line"><span class="attr">         path:</span> <span class="string">/data/k8s/pv-1</span></span><br><span class="line"><span class="attr">         server:</span> <span class="number">172.16</span><span class="number">.20</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">pv-2</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">       capacity:</span></span><br><span class="line"><span class="attr">         storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">       accessModes:</span></span><br><span class="line"><span class="bullet">         -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">       persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">       storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">       nfs:</span></span><br><span class="line"><span class="attr">         path:</span> <span class="string">/data/k8s/pv-2</span></span><br><span class="line"><span class="attr">         server:</span> <span class="number">172.16</span><span class="number">.20</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  - apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">pv-3</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">       capacity:</span></span><br><span class="line"><span class="attr">         storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">       accessModes:</span></span><br><span class="line"><span class="bullet">         -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">       persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">       storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">       nfs:</span></span><br><span class="line"><span class="attr">         path:</span> <span class="string">/data/k8s/pv-3</span></span><br><span class="line"><span class="attr">         server:</span> <span class="number">172.16</span><span class="number">.20</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>以前接触过在yaml文件中添加—3个横杠使的在一个文件中可以区分定义多个资源,这次定义一个List对象,然后把各个资源作为List对象的各个项目.这2种方法均可以在一个YAML文件中定义多个资源</p>
</blockquote>
<p>现在已经定义了个3个底层的PV持久卷</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get pv</span><br><span class="line">NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">mypv1   1Gi        RWO,ROX        Recycle          Available           nfs                     12d</span><br><span class="line">pv-1    1Gi        RWO            Recycle          Available           nfs                     4s</span><br><span class="line">pv-2    1Gi        RWO            Recycle          Available           nfs                     4s</span><br><span class="line">pv-3    1Gi        RWO            Recycle          Available           nfs                     4s</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="创建Headless-Service"><a href="#创建Headless-Service" class="headerlink" title="创建Headless Service"></a>创建Headless Service</h3><p>下面是headless service的配置文件,唯一需要注意的是该类型服务的clusterIP属性必须为None</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">statefulset-kubia-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="comment">#所有标签为statefulset-kubia的Pod都属于这个Service</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">statefulset-kubia</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>创建服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get svc</span><br><span class="line">NAME                    TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">statefulset-kubia-svc   ClusterIP      None            &lt;none&gt;        80/TCP         3s</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="创建Statefuleset"><a href="#创建Statefuleset" class="headerlink" title="创建Statefuleset"></a>创建Statefuleset</h3><p>​      statefulset资源的配置和RS,deployment等没有太大的区别,这里使用了一个新的组件volumeClaimTemplates.其中定义了一个持久卷声明.该组件会为每个Pod创建一个独立的持久卷声明.</p>
<p>​      这个组件是在statefulset资源的spec全局对象下,虽然在pod的template模板中并没有创建持久卷声明(而是直接通过volumeMounts属性来挂在).但是Statefulset在创建时,会自动将volumeClaimTemplate定义的持久卷声明关联到pod中.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">cat</span> <span class="string">statefulset-kubia.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">statefulset-kubia-v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">statefulset-kubia-v1</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">       app:</span> <span class="string">statefulset-kubia</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">statefulset-kubia</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">statefulset-kubia</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">luksa/kubia-pet</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">          - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">            containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/var/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  volumeClaimTemplates:</span></span><br><span class="line"><span class="attr">       - metadata:</span></span><br><span class="line"><span class="attr">           name:</span> <span class="string">data</span></span><br><span class="line"><span class="attr">         spec:</span></span><br><span class="line"><span class="attr">           resources:</span></span><br><span class="line"><span class="attr">              requests:</span></span><br><span class="line"><span class="attr">                 storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">           storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"><span class="attr">           accessModes:</span></span><br><span class="line"><span class="bullet">             -</span> <span class="string">ReadWriteOnce</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意:volumeClaimTemplates组件一定要声明存储类型storageClassName,如果没有声明这一点则Pod一直处于Pending状态.并且会有以下报错信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl describe po statefulset-kubia-v1-0</span><br><span class="line"></span><br><span class="line">  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  error while running &quot;VolumeBinding&quot; filter plugin for pod &quot;statefulset-kubia-v1-0&quot;: pod has unbound immediate PersistentVolumeClaims</span><br></pre></td></tr></table></figure>
<p>查看PVC提示没有找到PV</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl describe pvc data-statefulset-kubia-v1-0</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason         Age                  From                         Message</span><br><span class="line">  ----    ------         ----                 ----                         -------</span><br><span class="line">  Normal  FailedBinding  55s (x182 over 45m)  persistentvolume-controller  no persistent volumes available for this claim and no storage class is set</span><br></pre></td></tr></table></figure>
<p>   创建statefulset资源,列出pod资源.和rs,rc,deployment不同的是,他们会一次性创建完所有的pod,而statefulset会在每一个pod完全就绪后,才会创建第二个.</p>
<p>​    statefulset这样做是因为:状态明确的集群应用对同事有2个集群成员启动引起的竞争情况是非常敏感的.所以依次启动每个成员是比较安全可靠的.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@k8s-master</span> <span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span></span><br><span class="line"><span class="string">NAME</span>                     <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">statefulset-kubia-v1-0</span>   <span class="number">0</span><span class="string">/1</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="number">74</span><span class="string">s</span></span><br></pre></td></tr></table></figure>
<hr>
<p>现在3个Pod副本都已经被创建完成.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get pods</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Running   0          12m</span><br><span class="line">statefulset-kubia-v1-1   1/1     Running   0          12m</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running   0          12m</span><br></pre></td></tr></table></figure>
<p>statefulset自动创建了3个PVC,并且各自与3个pv自动关联</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pvc</span></span><br><span class="line">NAME                          STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">data-statefulset-kubia-v1-0   Bound    pv-2     1Gi        RWO            nfs            11m</span><br><span class="line">data-statefulset-kubia-v1-1   Bound    pv-3     1Gi        RWO            nfs            11m</span><br><span class="line">data-statefulset-kubia-v1-2   Bound    pv-1     1Gi        RWO            nfs            11m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pv</span></span><br><span class="line">NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                 STORAGECLASS   REASON   AGE</span><br><span class="line">pv-1   1Gi        RWO            Recycle          Bound    default/data-statefulset-kubia-v1-2   nfs                     5h18m</span><br><span class="line">pv-2   1Gi        RWO            Recycle          Bound    default/data-statefulset-kubia-v1-0   nfs                     5h18m</span><br><span class="line">pv-3   1Gi        RWO            Recycle          Bound    default/data-statefulset-kubia-v1-1   nfs                     5h18m</span><br><span class="line">[root@k8s-master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>​       和RS,RC,Deployment等资源不同的是,Statefulset部署的pod名称并非是随机的,而是pod模板名加上一个序号,这个序号从0开始,依次增加.</p>
<p>​       PVC的名称格式是PVC的名字+pod名.每个pod自动创建一个PVC,并且该PVC自动关联到一个后端的PV持久卷</p>
<hr>
<h3 id="访问POD"><a href="#访问POD" class="headerlink" title="访问POD"></a>访问POD</h3><p>​     由于创建的Service类型是Headless service模式,所以不能通过它来访问pod,而是需要直接连接到每个后端单独的pod.(或者是创建一个普通的Service,但是这样也不允许访问指定的pod)</p>
<p>​    这次介绍如何通过API服务器与pod通信.API服务器可以通过代理直接连接到指定的pod.可以通过如下的URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;apiServerHost&gt;:&lt;port&gt;/api/v1/namespaces/default/pods/pods名称/proxy/&lt;path&gt;</span><br></pre></td></tr></table></figure>
<p> 在k8s的master节点运行下面命令,下面命令运行一个kubectl proxy.从而可以让proxy去API服务器通信,而不必使用麻烦的授权和SSL证书来直接与API服务器通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure>
<p>现在就可以直接访问Pod了.开启另一个master服务器终端.通过curl访问某个Pod.比如访问statefulset-kubia-v1-0这个Pod容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-0/proxy/</span><br><span class="line">You&apos;ve hit statefulset-kubia-v1-0</span><br><span class="line">Data stored on this pod: No data posted yet</span><br></pre></td></tr></table></figure>
<p>这种访问方式经过了2层的中间代理:</p>
<h5 id="1-curl命令发送给kubectl-proxy"><a href="#1-curl命令发送给kubectl-proxy" class="headerlink" title="1.curl命令发送给kubectl proxy"></a>1.curl命令发送给kubectl proxy</h5><h5 id="2-kubectl-proxy-带上认证TOKEN转发给API服务器"><a href="#2-kubectl-proxy-带上认证TOKEN转发给API服务器" class="headerlink" title="2. kubectl proxy 带上认证TOKEN转发给API服务器"></a>2. kubectl proxy 带上认证TOKEN转发给API服务器</h5><h5 id="3-API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod"><a href="#3-API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod" class="headerlink" title="3. API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod"></a>3. API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod</h5><p>下面是发送一个post请求到statefulset-kubia-v1-0的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl -X POST -d &quot;Hey There ! This greeting was submitted to statefulset-kubia-v1-0&quot; \</span><br><span class="line">&gt; localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-0/proxy/</span><br><span class="line">Data stored on pod statefulset-kubia-v1-0</span><br><span class="line"></span><br><span class="line">#再次用GET请求,就可以返回刚才POST提交的数据</span><br><span class="line">[root@k8s-master ~]# curl localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-0/proxy/</span><br><span class="line">You&apos;ve hit statefulset-kubia-v1-0</span><br><span class="line">Data stored on this pod: Hey There ! This greeting was submitted to statefulset-kubia-v1-0</span><br></pre></td></tr></table></figure>
<p>当我们访问其他的pod容器时,并没有返回写入的数据,这和期望的一致,说明每个节点都有各自独立的存储状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-1/proxy/</span><br><span class="line">You&apos;ve hit statefulset-kubia-v1-1</span><br><span class="line">Data stored on this pod: No data posted yet</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="删除pod-重新调度"><a href="#删除pod-重新调度" class="headerlink" title="删除pod,重新调度"></a>删除pod,重新调度</h3><p>之前我们在statefulset-kubia-v1-0这个pod节点写入了一条数据,这次我们删除这个Pod,等它被重新调度,然后检查它是否还会返回与之前一致的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl delete po statefulset-kubia-v1-0</span><br><span class="line">pod &quot;statefulset-kubia-v1-0&quot; deleted</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# kubectl get po</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Running   0          2m</span><br><span class="line">statefulset-kubia-v1-1   1/1     Running   0          17h</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running   0          17h</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]# curl localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-0/proxy/</span><br><span class="line">You&apos;ve hit statefulset-kubia-v1-0</span><br><span class="line">Data stored on this pod: Hey There ! This greeting was submitted to statefulset-kubia-v1-0</span><br><span class="line">[root@k8s-master ~]#</span><br></pre></td></tr></table></figure>
<blockquote>
<p>删除一个Pod,当Pod重新被调度时不一定是原节点,有可能会调度到另外一个节点</p>
</blockquote>
<p>从上面的实验中可以得出2个结论:</p>
<ul>
<li>statefulset的pod被重新调度时,会新创建一个和之前一模一样的Pod(包括主机名称,pod名,存储)</li>
<li>当pod被删除,重新调度后持久化数据与之前一模一样.</li>
</ul>
<hr>
<h3 id="statefulSet滚动更新"><a href="#statefulSet滚动更新" class="headerlink" title="statefulSet滚动更新"></a>statefulSet滚动更新</h3><h4 id="1-7版本之前默认的On-Delete更新策略"><a href="#1-7版本之前默认的On-Delete更新策略" class="headerlink" title="1.7版本之前默认的On Delete更新策略"></a>1.7版本之前默认的On Delete更新策略</h4><p>​     statefulset在1.7版本开始支持滚动更新..在1.7版本之前默认的更新测量是<figure class="highlight plain"><figcaption><span>Delete```.这种侧列和ReplicaSet类似.当更新了配置文件后,旧的pod并不会被自动删除,而是需要手动删除.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">​    下面这个例子中,将镜像更换为luksa/kubia-pet-peers.副本数从3个增加到4个.(为此,我们需要提前再创建一个pv-4</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">#编辑pv配置文件,增加pv-4(前提是nfs服务器上实现存在/data/k8s/pv-4目录</span><br><span class="line">[root@k8s-master ~]# vim statefulset-kubia-pv.yaml</span><br><span class="line"></span><br><span class="line">#更新pv配置文件</span><br><span class="line">[root@k8s-master ~]# kubectl apply -f statefulset-kubia-pv.yaml</span><br><span class="line">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span><br><span class="line">persistentvolume/pv-1 configured</span><br><span class="line">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span><br><span class="line">persistentvolume/pv-2 configured</span><br><span class="line">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span><br><span class="line">persistentvolume/pv-3 configured</span><br><span class="line">persistentvolume/pv-4 created</span><br><span class="line"></span><br><span class="line">#查看PV.</span><br><span class="line">[root@k8s-master ~]# kubectl get pv</span><br><span class="line">NAME   CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                                 STORAGECLASS   REASON   AGE</span><br><span class="line">pv-1   1Gi        RWO            Recycle          Bound       default/data-statefulset-kubia-v1-2   nfs                     23h</span><br><span class="line">pv-2   1Gi        RWO            Recycle          Bound       default/data-statefulset-kubia-v1-0   nfs                     23h</span><br><span class="line">pv-3   1Gi        RWO            Recycle          Bound       default/data-statefulset-kubia-v1-1   nfs                     23h</span><br><span class="line">pv-4   1Gi        RWO            Recycle          Available                                         nfs                     9s</span><br><span class="line">[root@k8s-master ~]#</span><br></pre></td></tr></table></figure></p>
<p>更新statefulset配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#更新配置文件</span><br><span class="line">[root@k8s-master ~]# vim statefulset-kubia.yaml</span><br><span class="line">#应用配置文件</span><br><span class="line">[root@k8s-master ~]# kubectl apply -f statefulset-kubia.yaml</span><br><span class="line">Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply</span><br><span class="line">statefulset.apps/statefulset-kubia-v1 configured</span><br><span class="line"></span><br><span class="line">#查看Pod</span><br><span class="line">[root@k8s-master ~]# kubectl get pods</span><br><span class="line">NAME                     READY   STATUS              RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Running             0          70m</span><br><span class="line">statefulset-kubia-v1-1   1/1     Running             0          18h</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running             0          18h</span><br><span class="line">statefulset-kubia-v1-3   0/1     ContainerCreating   0          5s</span><br><span class="line">[root@k8s-master ~]#</span><br></pre></td></tr></table></figure>
<p>通过Pod的存活字段可以看到之前旧版本的Pod并没有被自动删除,而是新增了一个副本.这和ReplicaSet的机制类似.</p>
<hr>
<h4 id="自动滚动更新策略"><a href="#自动滚动更新策略" class="headerlink" title="自动滚动更新策略"></a>自动滚动更新策略</h4><p>编辑statefulset配置文件,将镜像版本改回到luksa/kubia-pet</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  serviceName:</span> <span class="string">statefulset-kubia-v1</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">       app:</span> <span class="string">statefulset-kubia</span></span><br><span class="line">  <span class="comment">#在spec字段配置更新策略,默认的type是On Delete,修改为RollingUpdate</span></span><br><span class="line"><span class="attr">  updateStrategy:</span></span><br><span class="line"><span class="attr">     type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure>
<p>应用新的配置文件,此时会触发自动更新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl apply -f statefulset-kubia.yaml</span></span><br><span class="line">statefulset.apps/statefulset-kubia-v1 configured</span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Running       0          5m22s</span><br><span class="line">statefulset-kubia-v1-1   1/1     Running       0          6m12s</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running       0          6m57s</span><br><span class="line">statefulset-kubia-v1-3   1/1     Terminating   0          7m39s</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Running       0          6m55s</span><br><span class="line">statefulset-kubia-v1-1   1/1     Terminating   0          7m45s</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running       0          14s</span><br><span class="line">statefulset-kubia-v1-3   1/1     Running       0          54s</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE</span><br><span class="line">statefulset-kubia-v1-0   1/1     Terminating   0          7m27s</span><br><span class="line">statefulset-kubia-v1-1   1/1     Running       0          7s</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running       0          46s</span><br><span class="line">statefulset-kubia-v1-3   1/1     Running       0          86s</span><br></pre></td></tr></table></figure>
<p>发现了什么? 当滚动更新时,kubectl会以倒序的方式,从最末尾一个pod开始依次更新.</p>
<blockquote>
<p>StatefulSet的滚动更新策略不同于Deployment可以指定maxSuge参数指定一次同时更新的pod数量,而是只能单个方式进行依次更新</p>
</blockquote>
<blockquote>
<p>StatefulSet还支持partition(分区)的更新策略,具体可以查看官网</p>
</blockquote>
<p>无论是何种更新策略.Pod的数据(包括主机名,存储)都会持久化.再次访问第0个pod,存储数据依然存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# curl localhost:8001/api/v1/namespaces/default/pods/statefulset-kubia-v1-0/proxy/</span><br><span class="line">You&apos;ve hit statefulset-kubia-v1-0</span><br><span class="line">Data stored on this pod: Hey There ! This greeting was submitted to statefulset-kubia-v1-0</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="StatefulSet-如何处理节点失效"><a href="#StatefulSet-如何处理节点失效" class="headerlink" title="StatefulSet 如何处理节点失效"></a>StatefulSet 如何处理节点失效</h3><p>在node2上关闭网卡来模拟这台服务器掉线,观察statefulSet处理节点失效的情况</p>
<blockquote>
<p>注意关闭节点网卡前请确保可以通过控制台连接服务器,因为这意味着无法ssh远程登录</p>
</blockquote>
<p>node2节点已经关闭,状态为notready</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl get node</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master   Ready      master   49d   v1.17.3</span><br><span class="line">k8s-node1    Ready      &lt;none&gt;   49d   v1.17.3</span><br><span class="line">k8s-node2    NotReady   &lt;none&gt;   49d   v1.17.3</span><br></pre></td></tr></table></figure>
<p>过一段时间后,所有node2节点上的Pod为Terminating终止状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                     READY   STATUS        RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">statefulset-kubia-v1-0   1/1     Terminating   0          33m   10.100.169.174   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">statefulset-kubia-v1-1   1/1     Terminating   0          34m   10.100.169.173   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">statefulset-kubia-v1-2   1/1     Running       0          34m   10.100.36.97     k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">statefulset-kubia-v1-3   1/1     Running       0          35m   10.100.36.99     k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h5 id="删除不健康的Pod"><a href="#删除不健康的Pod" class="headerlink" title="删除不健康的Pod"></a>删除不健康的Pod</h5><p>当尝试手动删除pod时,发现永远都无法删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]# kubectl delete po statefulset-kubia-v1-0</span><br><span class="line">pod &quot;statefulset-kubia-v1-0&quot; deleted</span><br><span class="line">^@</span><br><span class="line">^@</span><br></pre></td></tr></table></figure>
<p>在另一个终端上查看该pod.发现虽然pod被Terminating挂起,但是容器仍然处于运行状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe pods statefulset-kubia-v1-0</span></span><br><span class="line">Name:                      statefulset-kubia-v1-0</span><br><span class="line">Namespace:                 default</span><br><span class="line">Priority:                  0</span><br><span class="line">Node:                      k8s-node2/172.16.20.253</span><br><span class="line">Start Time:                Sun, 03 May 2020 10:54:17 +0800</span><br><span class="line">Labels:                    app=statefulset-kubia</span><br><span class="line">                           controller-revision-hash=statefulset-kubia-v1-74b44bc68b</span><br><span class="line">                           statefulset.kubernetes.io/pod-name=statefulset-kubia-v1-0</span><br><span class="line">Annotations:               cni.projectcalico.org/podIP: 10.100.169.174/32</span><br><span class="line">Status:                    Terminating (lasts 12m)</span><br><span class="line">Termination Grace Period:  30s</span><br><span class="line">IP:                        10.100.169.174</span><br><span class="line">IPs:</span><br><span class="line">  IP:           10.100.169.174</span><br><span class="line">Controlled By:  StatefulSet/statefulset-kubia-v1</span><br><span class="line">Containers:</span><br><span class="line">  statefulset-kubia:</span><br><span class="line">    Container ID:   docker://099628b95ded3644752a3de799ef338794704aaa4ebe4db5a966b821b2e9a71a</span><br><span class="line">    Image:          luksa/kubia-pet</span><br><span class="line">    Image ID:       docker-pullable://luksa/kubia-pet@sha256:4263bc375d3ae2f73fe7486818cab64c07f9cd4a645a7c71a07c1365a6e1a4d2</span><br><span class="line">    Port:           8080/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Sun, 03 May 2020 10:54:21 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/data from data (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-jfrqr (ro)</span><br></pre></td></tr></table></figure>
<h5 id="强制删除"><a href="#强制删除" class="headerlink" title="强制删除"></a>强制删除</h5><p>带上参数<figure class="highlight plain"><figcaption><span>--grace-period 0```可以强制删除一个pod</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>[root@k8s-master ~]# kubectl delete po statefulset-kubia-v1-0 –force –grace-period 0<br>warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.<br>pod “statefulset-kubia-v1-0” force deleted</p>
<p>[root@k8s-master ~]# kubectl get pods<br>NAME                     READY   STATUS              RESTARTS   AGE<br>statefulset-kubia-v1-0   0/1     ContainerCreating   0          5s<br>statefulset-kubia-v1-1   1/1     Terminating         0          44m<br>statefulset-kubia-v1-2   1/1     Running             0          44m<br>statefulset-kubia-v1-3   1/1     Running             0          45m</p>
<p>[root@k8s-master ~]# kubectl get pods -o wide<br>NAME                     READY   STATUS        RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES<br>statefulset-kubia-v1-0   1/1     Running       0          12s   10.100.36.101    k8s-node1   <none>           <none><br>statefulset-kubia-v1-1   1/1     Terminating   0          44m   10.100.169.173   k8s-node2   <none>           <none><br>statefulset-kubia-v1-2   1/1     Running       0          44m   10.100.36.97     k8s-node1   <none>           <none><br>statefulset-kubia-v1-3   1/1     Running       0          45m   10.100.36.99     k8s-node1   <none>           <none><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">此时第0个pod已经重新创建,并且运行到node1节点,而另一个pod依然处于Terminating状态</span><br><span class="line"></span><br><span class="line">##### node2节点恢复正常</span><br><span class="line"></span><br><span class="line">当节点恢复正常后,很快node和pod都全部恢复正常.此时第0个pod依然还是挂在在node1节点.第1个pod的状态迅速从Terminating状态变为Running状态</span><br></pre></td></tr></table></figure></none></none></none></none></none></none></none></none></p>
<p>[root@k8s-master ~]# kubectl get pods -o wide<br>NAME                     READY   STATUS    RESTARTS   AGE     IP               NODE        NOMINATED NODE   READINESS GATES<br>statefulset-kubia-v1-0   1/1     Running   0          3m17s   10.100.36.101    k8s-node1   <none>           <none><br>statefulset-kubia-v1-1   1/1     Running   0          5s      10.100.169.172   k8s-node2   <none>           <none><br>statefulset-kubia-v1-2   1/1     Running   0          47m     10.100.36.97     k8s-node1   <none>           <none><br>statefulset-kubia-v1-3   1/1     Running   0          48m     10.100.36.99     k8s-node1   <none>           <none><br><code>`</code></none></none></none></none></none></none></none></none></p>
<hr>
<h3 id="本章总结"><a href="#本章总结" class="headerlink" title="本章总结"></a>本章总结</h3><p>Stateful和RS,deployment的用法总体没有太大区别,下面是这2种资源的对比</p>
<table>
<thead>
<tr>
<th style="text-align:center">特性</th>
<th style="text-align:center">Deployment</th>
<th style="text-align:center">StatefulSet</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">是否暴露到外网</td>
<td style="text-align:center">可以</td>
<td style="text-align:center">一般不</td>
</tr>
<tr>
<td style="text-align:center">请求面向的对象</td>
<td style="text-align:center">ServiceName</td>
<td style="text-align:center">指定pod的域名</td>
</tr>
<tr>
<td style="text-align:center">灵活性</td>
<td style="text-align:center">通过Service(名称或者IP)访问后端Pod</td>
<td style="text-align:center">可以访问任意一个pod</td>
</tr>
<tr>
<td style="text-align:center">易用性</td>
<td style="text-align:center">只需要关心Service信息即可</td>
<td style="text-align:center">需要知道访问pod的名称,Headless Service名称</td>
</tr>
<tr>
<td style="text-align:center">PV/PVC稳定性</td>
<td style="text-align:center">无法保障绑定关系</td>
<td style="text-align:center">可以保障</td>
</tr>
<tr>
<td style="text-align:center">pod名称稳定性</td>
<td style="text-align:center">使用一个随机的名称后缀,重启后会随机生成另外一个.名称不重复</td>
<td style="text-align:center">稳定,每次都一样</td>
</tr>
<tr>
<td style="text-align:center">升级更新顺序</td>
<td style="text-align:center">随机启动.如果pod宕机重启,也是随机分配一个Node节点重新启动</td>
<td style="text-align:center">pod按顺序依次启动,如果pod宕机,依然使用相同的Node节点和名称</td>
</tr>
<tr>
<td style="text-align:center">停止顺序</td>
<td style="text-align:center">随机停止</td>
<td style="text-align:center">倒序停止</td>
</tr>
<tr>
<td style="text-align:center">集群内部服务发现</td>
<td style="text-align:center">只能通过Service访问随机的一个Pod</td>
<td style="text-align:center">可以打通pod之间的通信</td>
</tr>
<tr>
<td style="text-align:center">性能开销</td>
<td style="text-align:center">无需维护pod与node,pvc等关系</td>
<td style="text-align:center">需要维护额外的关系信息</td>
</tr>
</tbody>
</table>
<p>通过对比发现</p>
<ul>
<li>如果不需要额外数据依赖或者状态维护的部署,优先选择Deployment</li>
<li>如果单纯要做数据持久化,方式pod宕机数据丢失,直接使用PV/PVC就可以</li>
<li>如果是有多个副本,且每个副本挂载的PV存储数据不同,并且pod宕机重启后仍然关联到之前的PVC,并且数据需要持久化,考虑使用StatefulSet</li>
</ul>

      
    </div>
    
    
    
   
    <div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2020/06/26/kubernetes/kubernetes headless Service/">kubernetes headless Service</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 Jesse 的个人博客">Jesse</a></p>
  <p><span>发布时间:</span>2020年06月26日 - 11:06</p>
  <p><span>最后更新:</span>2020年06月26日 - 16:06</p>
  <p><span>原始链接:</span><a href="/2020/06/26/kubernetes/kubernetes headless Service/" title="kubernetes headless Service">https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">禁止商业用途</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
      $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
        });
    });  
</script>

      
    </div>

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="Jesse 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Jesse 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"># k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/26/kubernetes/kubernetes Ingress/" rel="next" title="kuberentes Ingress">
                <i class="fa fa-chevron-left"></i> kuberentes Ingress
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/26/kubernetes/kubernetes volume存储卷/" rel="prev" title="kubernetes volume">
                kubernetes volume <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2020/06/26/kubernetes/kubernetes headless Service/"
           data-title="kubernetes headless Service" data-url="https://jesse.top/2020/06/26/kubernetes/kubernetes headless Service/">
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="Jesse" />
            
              <p class="site-author-name" itemprop="name">Jesse</p>
              <p class="site-description motion-element" itemprop="description">求知若饥,虚心若愚.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">162</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-headless-Service"><span class="nav-number">1.</span> <span class="nav-text">kubernetes headless Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久存储"><span class="nav-number">2.</span> <span class="nav-text">持久存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久卷的创建和删除"><span class="nav-number">3.</span> <span class="nav-text">持久卷的创建和删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署StatefulSet应用"><span class="nav-number">4.</span> <span class="nav-text">部署StatefulSet应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#准备一个docker镜像"><span class="nav-number">4.1.</span> <span class="nav-text">准备一个docker镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建持久化存储卷-pv"><span class="nav-number">4.2.</span> <span class="nav-text">创建持久化存储卷(pv)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Headless-Service"><span class="nav-number">5.</span> <span class="nav-text">创建Headless Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Statefuleset"><span class="nav-number">6.</span> <span class="nav-text">创建Statefuleset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问POD"><span class="nav-number">7.</span> <span class="nav-text">访问POD</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-curl命令发送给kubectl-proxy"><span class="nav-number">7.0.1.</span> <span class="nav-text">1.curl命令发送给kubectl proxy</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-kubectl-proxy-带上认证TOKEN转发给API服务器"><span class="nav-number">7.0.2.</span> <span class="nav-text">2. kubectl proxy 带上认证TOKEN转发给API服务器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod"><span class="nav-number">7.0.3.</span> <span class="nav-text">3. API服务器再通过pod容器的实际IP地址将请求转发到后端的Pod</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除pod-重新调度"><span class="nav-number">8.</span> <span class="nav-text">删除pod,重新调度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#statefulSet滚动更新"><span class="nav-number">9.</span> <span class="nav-text">statefulSet滚动更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-7版本之前默认的On-Delete更新策略"><span class="nav-number">9.1.</span> <span class="nav-text">1.7版本之前默认的On Delete更新策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自动滚动更新策略"><span class="nav-number">9.2.</span> <span class="nav-text">自动滚动更新策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StatefulSet-如何处理节点失效"><span class="nav-number">10.</span> <span class="nav-text">StatefulSet 如何处理节点失效</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#删除不健康的Pod"><span class="nav-number">10.0.1.</span> <span class="nav-text">删除不健康的Pod</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#强制删除"><span class="nav-number">10.0.2.</span> <span class="nav-text">强制删除</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本章总结"><span class="nav-number">11.</span> <span class="nav-text">本章总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; Tue Jun 12 2018 08:00:00 GMT+0800 (中国标准时间) &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jesse</span>

  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"comments"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '3CtYiIp3Dijlw0XHyLxqMUM0-gzGzoHsz',
        appKey: '6dleF8bCPBg8gTr0pBp1IgVe',
        placeholder: '欢迎留言交流',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
